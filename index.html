<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>For Dananjaya</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=Meie+Script&family=VT323&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --gold: #d4af37;
        --dark: #050505;
      }

      * {
        -webkit-tap-highlight-color: transparent;
      }

      body {
        background-color: var(--dark);
        background-image: radial-gradient(
            circle at 50% 50%,
            rgba(20, 20, 20, 0.8) 0%,
            rgba(0, 0, 0, 1) 100%
          ),
          url("https://www.transparenttextures.com/patterns/stardust.png");
        font-family: "Cormorant Garamond", serif;
        color: #e2e8f0;
        overflow-x: hidden;
        overflow-y: auto;
        touch-action: pan-y;
        user-select: none;
        -webkit-user-select: none;
        position: fixed;
        width: 100%;
        height: 100%;
      }

      h1,
      h2,
      .cinzel {
        font-family: "Cinzel", serif;
      }
      .script {
        font-family: "Meie Script", cursive;
      }
      .pixel-font {
        font-family: "VT323", monospace;
      }

      .glass-panel {
        background: rgba(10, 10, 15, 0.9);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid rgba(212, 175, 55, 0.3);
        box-shadow: 0 0 50px rgba(0, 0, 0, 0.9),
          inset 0 0 20px rgba(0, 0, 0, 0.5);
      }

      .btn-magic {
        background: linear-gradient(45deg, #1e1e2f, #2d2d44);
        border: 1px solid var(--gold);
        color: var(--gold);
        box-shadow: 0 0 10px rgba(212, 175, 55, 0.2);
        transition: all 0.3s ease;
      }
      .btn-magic:hover {
        box-shadow: 0 0 20px rgba(212, 175, 55, 0.4);
      }
      .btn-magic:active {
        transform: scale(0.95);
      }

      .sprite-float {
        animation: float 3s ease-in-out infinite;
      }
      @keyframes float {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      .dialogue-box {
        background: rgba(0, 0, 0, 0.95);
        border: 2px solid var(--gold);
        position: relative;
      }
      .dialogue-triangle {
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-top: 10px solid var(--gold);
        position: absolute;
        bottom: -12px;
        left: 50%;
        transform: translateX(-50%);
      }

      .cursor::after {
        content: "‚ñã";
        animation: blink 1s infinite;
      }
      @keyframes blink {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0;
        }
      }

      .fade-in {
        animation: fadeIn 0.5s ease-forwards;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .particle {
        position: absolute;
        pointer-events: none;
        animation: particleFade 1s ease-out forwards;
      }
      @keyframes particleFade {
        0% {
          transform: translate(0, 0) scale(1);
          opacity: 1;
        }
        100% {
          transform: translate(var(--tx), var(--ty)) scale(0);
          opacity: 0;
        }
      }

      .star-guide::after {
        content: "";
        position: absolute;
        top: -10px;
        left: -10px;
        right: -10px;
        bottom: -10px;
        border: 2px solid gold;
        border-radius: 50%;
        animation: guidePulse 1.5s infinite;
      }
      @keyframes guidePulse {
        0% {
          transform: scale(0.8);
          opacity: 1;
        }
        100% {
          transform: scale(1.5);
          opacity: 0;
        }
      }

      canvas {
        touch-action: none;
      }
      #particles {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
        pointer-events: none;
      }

      .game-container {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        padding-bottom: 220px;
      }

      #character-layer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        padding-bottom: env(safe-area-inset-bottom, 0);
        pointer-events: none; /* Keep this */
        z-index: 50; /* Keep this */
      }

      /* Make sure only interactive elements get pointer events */
      #character-layer .dialogue-box {
        pointer-events: auto;
        margin-bottom: 0.5rem; /* Reduce overlap */
      }

      .snitch-trail {
        position: absolute;
        width: 8px;
        height: 8px;
        background: radial-gradient(circle, gold, transparent);
        border-radius: 50%;
        pointer-events: none;
        animation: trailFade 0.5s ease-out forwards;
      }
      @keyframes trailFade {
        to {
          opacity: 0;
          transform: scale(0.5);
        }
      }

      .star-glow {
        box-shadow: 0 0 20px currentColor, 0 0 40px currentColor;
        animation: starPulse 2s ease-in-out infinite;
      }
      @keyframes starPulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }

      /* --- NEW VIDEO TRANSITION STYLES --- */
      #lumos-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: black;
        z-index: 9999;
        pointer-events: none;
        opacity: 0;
      }

      .lumos-active {
        animation: lumosEffect 4s ease-in-out forwards;
      }

      @keyframes lumosEffect {
        0% {
          opacity: 0;
          background: black;
        }
        30% {
          opacity: 1;
          background: black;
        }
        35% {
          opacity: 1;
          background: radial-gradient(
            circle,
            rgba(255, 255, 255, 1) 0%,
            rgba(200, 230, 255, 1) 10%,
            rgba(0, 0, 0, 1) 40%
          );
        }
        45% {
          opacity: 1;
          background: white;
        }
        80% {
          opacity: 1;
          background: white;
        }
        100% {
          opacity: 0;
          display: none;
        }
      }

      @media (max-height: 700px) {
        .game-container {
          padding-bottom: 200px;
        }
      }
    </style>
  </head>
  <body>
    <div id="particles"></div>
    <div id="lumos-overlay"></div>

    <div class="game-container">
      <main
        id="game-stage"
        class="relative z-10 w-full max-w-lg mx-auto p-4 flex flex-col items-center justify-center flex-1 transition-all duration-500"
      ></main>
    </div>

    <div
      id="character-layer"
      class="z-50 flex flex-col items-center pointer-events-none hidden opacity-0 transition-opacity duration-1000"
    >
      <div
        id="speech-bubble"
        class="dialogue-box w-11/12 max-w-md p-4 rounded-lg mb-2 mx-auto pointer-events-auto cursor-pointer shadow-[0_0_30px_rgba(0,0,0,0.8)] opacity-0 transition-opacity duration-300"
        onclick="advanceDialogue()"
      >
        <p
          id="dialogue-text"
          class="text-xl text-yellow-100 pixel-font leading-relaxed tracking-wide min-h-[3rem]"
        ></p>
        <div class="text-right text-xs text-yellow-500 mt-2 animate-pulse">
          ‚ñº Tap to continue
        </div>
        <div class="dialogue-triangle"></div>
      </div>

      <img
        src="/owl.png"
        alt="Owl Guide"
        class="w-28 h-28 sprite-float drop-shadow-[0_0_25px_rgba(212,175,55,0.4)] filter brightness-110"
      />
    </div>

    <script>
      const PLAYER_NAME = "Dananjaya Gomes";

      // --- üíå LOVE NOTES üíå ---
      const LOVE_NOTES = {
        afterLevel1: {
          title: "A Spark",
          body: `My Bubba, <br><br> Just like a first spark of magic, you changed everything the moment you came into my life.
                        You have a quiet way of making the ordinary feel warmer, brighter, and a little more magical. <br><br>Keep going, my wizard.`,
          signature: "Your Isaac",
        },
        afterLevel2: {
          title: "The Catch",
          body: `My Bebeh, <br><br> You‚Äôve always been the one who steadies me, who shows up, who makes me feel safe just by being there.
                        Being chosen by you is my greatest win ‚Äî no spell or trophy could ever compare. <br><br>One last trial remains.`,
          signature: "Always yours",
        },
      };

      const SCRIPT = {
        intro: [
          "Hoo‚Ä¶ Hoo‚Ä¶ ü¶â",
          "Oh wow, look who we have here‚Ä¶ it‚Äôs you. In case you didn‚Äôt guess, I‚Äôm an owl. Feathers, beak, the whole glamorous package. Yes, you‚Äôre welcome.",
          "I‚Äôve been sent by someone suuuper special (yep, your *bebe*) to deliver a letter. Try not to cry, faint, or explode from excitement. Or do, I‚Äôm not your therapist.",
          "Brace yourself‚Ä¶ apparently, you‚Äôre a WIZARD. I know, shocking, right? Who would‚Äôve thought? Not me‚Ä¶ I‚Äôm just here for the drama.",
          "Hogwarts is calling, darling. Pack a bag, grab a wand, maybe brush up on literally any spell, because apparently they expect you to know things.",
          "But before we let you loose on enchanted hallways and creepy staircases, we need to see where your loyalty lies. Step forward, and let destiny (and the very judgy portraits) decide‚Ä¶ if it even cares.",
        ],

        houseChosen: (house) => [
          `Ah, ${house}! An *interesting* choice‚Ä¶ I see you‚Äôre living dangerously.`,
          "Now, let's see if your wand skills are actually as impressive as your ego claims.",
          "Your first challenge awaits in the Mind Palace Chamber. Spoiler: it‚Äôs harder than remembering your own birthday.",
          "Solve the puzzles, remember the sequences, and prove your brain is at least 73% magical. The other 27%? Probably sarcasm like mine.",
        ],

        level1Done: [
          "Brilliant! You‚Äôve conquered the Mind Game without turning yourself into a toad. Impressive‚Ä¶ for a human.",
          "But wait‚Ä¶ the Owl swoops in like a diva with another envelope.",
          "It looks like‚Ä¶ yes, another letter. Sealed with a magical emblem. Because one letter was obviously not enough.",
          "Open it if you dare. Or don‚Äôt. I literally don‚Äôt care. I‚Äôm just here for the drama.",
        ],

        level2Intro: [
          "Alright, reflexes time. Your wizarding charm won‚Äôt help if you‚Äôre slow‚Ä¶ or clumsy‚Ä¶ or both.",
          "Can you catch the Golden Snitch before it disappears into another dimension, or, you know‚Ä¶ the corner of your eye?",
          "Click wisely, young Seeker. Miss five times and the Snitch might start giving *you* life advice.",
          "Remember: the Snitch is fast, cunning, and possibly caffeinated. You‚Äôve been warned.",
        ],

        level2Done: [
          "Whoa! You actually caught it. I‚Äôm impressed. The Snitch is questioning its life choices now.",
          "Another message appears midair‚Ä¶ because apparently Hogwarts likes drama, too.",
          "Do you open it? Or stare at it suspiciously? Honestly, I‚Äôm judging both choices equally.",
        ],

        level3Intro: [
          "Final test. And yes, it‚Äôs dramatic. Cue mysterious music and sparkly lights.",
          "This requires wisdom, patience, and maybe some heart vibes. Or at least pretend to care.",
          "Connect the stars to reveal the constellation of the heart. Don‚Äôt worry, the stars won‚Äôt judge your art‚Ä¶ much.",
          "Mistakes may happen‚Ä¶ but legends are born from imperfect constellations. Or mediocre ones. Depends on perspective.",
        ],

        finale: [
          "You have proven yourself worthy‚Ä¶ somehow.",
          "The magical seal is broken. The owl claps. Very subtle applause, obviously.",
          "Prepare yourself‚Ä¶ for the true magic‚Äîprobably chocolate, self-esteem, or just more letters‚Äîis about to be revealed.",
          "Congratulations! You survived all three trials without turning into a cinnamon roll. Mostly.",
        ],
      };

      const STATE = {
        house: null,
        dialogueQueue: [],
        isTyping: false,
        onDialogueComplete: null,
      };

      let CURRENT_LEVEL = 0;
      let GAME_COMPLETED = false;
      let GAME_IN_PROGRESS = false;
      let LETTER_OPEN = false;

      const stage = document.getElementById("game-stage");
      const charLayer = document.getElementById("character-layer");
      const bubbleLayer = document.getElementById("speech-bubble");
      const bubbleText = document.getElementById("dialogue-text");

      window.onload = () => {
        initParticles();
        charLayer.classList.remove("hidden");
        setTimeout(() => charLayer.classList.remove("opacity-0"), 500);
        startDialogue(SCRIPT.intro, renderHouseSelection);
      };

      function startDialogue(lines, callback) {
        STATE.dialogueQueue = [...lines];
        STATE.onDialogueComplete = callback;
        // üîß UPDATE THIS: Properly show character layer
        charLayer.classList.remove("hidden");
        setTimeout(() => {
          charLayer.classList.remove("opacity-0");
          bubbleLayer.classList.remove("opacity-0");
        }, 50);
        advanceDialogue();
      }

      function advanceDialogue() {
        if (STATE.isTyping) {
          STATE.isTyping = false;
          bubbleText.innerHTML = bubbleText.dataset.fullText;
          bubbleText.classList.remove("cursor");
          return;
        }
        if (STATE.dialogueQueue.length === 0) {
          bubbleLayer.classList.add("opacity-0");
          if (STATE.onDialogueComplete) STATE.onDialogueComplete();
          return;
        }
        typeText(STATE.dialogueQueue.shift());
      }

      function typeText(text) {
        STATE.isTyping = true;
        bubbleText.innerHTML = "";
        bubbleText.dataset.fullText = text;
        bubbleText.classList.add("cursor");
        let i = 0;
        const step = () => {
          if (!STATE.isTyping) return;
          if (i < text.length) {
            bubbleText.innerHTML += text.charAt(i);
            i++;
            setTimeout(step, 30);
          } else {
            STATE.isTyping = false;
            bubbleText.classList.remove("cursor");
          }
        };
        step();
      }

      function renderHouseSelection() {
        const houses = [
          {
            id: "gryffindor",
            label: "Gryffindor",
            icon: "ü¶Å",
            color: "text-red-500",
          },
          {
            id: "slytherin",
            label: "Slytherin",
            icon: "üêç",
            color: "text-green-500",
          },
          {
            id: "ravenclaw",
            label: "Ravenclaw",
            icon: "ü¶Ö",
            color: "text-blue-400",
          },
          {
            id: "hufflepuff",
            label: "Hufflepuff",
            icon: "ü¶°",
            color: "text-yellow-400",
          },
        ];

        stage.innerHTML = `
                <div class="glass-panel p-6 rounded-xl w-full fade-in text-center">
                    <h2 class="cinzel text-2xl text-white mb-6">Choose Your House</h2>
                    <div class="grid grid-cols-2 gap-4">
                        ${houses
                          .map(
                            (h) => `
                            <button onclick="selectHouse('${h.id}', '${h.label}')" class="btn-magic p-4 rounded-lg flex flex-col items-center gap-2 group">
                                <span class="text-4xl transition-transform group-hover:scale-110">${h.icon}</span>
                                <span class="cinzel text-sm ${h.color}">${h.label}</span>
                            </button>
                        `
                          )
                          .join("")}
                    </div>
                </div>
            `;
      }

      function selectHouse(id, label) {
        STATE.house = label;
        document.body.setAttribute("data-house", id);
        startDialogue(SCRIPT.houseChosen(label), startLevel1);
      }

      // --- INTERMEDIATE LETTER SYSTEM ---
      function showIntermediateLetter(contentData, nextCallback) {
        if (LETTER_OPEN) return;
        LETTER_OPEN = true;
        // Hide owl temporarily
        charLayer.classList.add("opacity-0");
        charLayer.style.zIndex = "0";

        stage.innerHTML = `
                <div class="w-full max-w-md fade-in py-10">
                    <div id="envelope" onclick="openIntermediateLetter(this)" class="bg-[#f3e5ab] text-black p-8 rounded-lg shadow-2xl relative transform transition-all duration-1000 cursor-pointer border-2 border-[#e6cca0]">
                        <div id="seal" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-center z-10">
                            <div class="w-24 h-24 bg-red-900 rounded-full mx-auto border-4 border-red-950 flex items-center justify-center shadow-lg">
                                <span class="cinzel text-4xl text-red-200 font-bold">T</span>
                            </div>
                            <p class="cinzel mt-4 text-sm tracking-widest text-gray-700 animate-pulse">Tap to Open</p>
                        </div>
                        <div id="letter-content" class="hidden opacity-0 transition-opacity duration-1000">
                            <h2 class="cinzel text-center text-xl font-bold border-b-2 border-black pb-4 mb-6">${contentData.title}</h2>
                            <div class="text-base leading-relaxed space-y-4">
                                <p>${contentData.body}</p>
                            </div>
                            <div class="mt-8 text-right border-t-2 border-gray-300 pt-6">
                                <p class="script text-2xl mt-2 text-gray-800">${contentData.signature}</p>
                            </div>
                            <button
                                id="continue-btn"
                                class="cinzel px-6 py-2 bg-[#fffaf0] text-black border-2 border-[#d4af37] rounded
                                        hover:bg-[#d4af37] hover:text-black
                                        hover:shadow-[0_0_15px_rgba(212,175,55,0.6)]
                                        transition-all duration-300">
                                Continue Journey
                            </button>

                        </div>
                    </div>
                </div>
            `;

        // Assign the callback to the window so the button can find it
        window.nextLevelAction = nextCallback;
      }

      window.openIntermediateLetter = function (el) {
        const seal = document.getElementById("seal");
        if (!seal || seal.style.display === "none") return;

        el.onclick = null; // üîí prevent re-opening

        seal.style.transform = "scale(0) rotate(180deg)";
        seal.style.opacity = "0";

        setTimeout(() => {
          seal.style.display = "none";

          const content = document.getElementById("letter-content");
          content.classList.remove("hidden");
          requestAnimationFrame(() => (content.style.opacity = "1"));

          const btn = document.getElementById("continue-btn");
          if (btn) {
            btn.onclick = (e) => {
              e.stopPropagation();

              // üîß ADD THIS: Disable button immediately to prevent multiple clicks
              btn.disabled = true;
              btn.style.opacity = "0.5";
              btn.style.cursor = "not-allowed";

              el.style.opacity = "0";
              el.style.pointerEvents = "none";

              setTimeout(() => {
                stage.innerHTML = "";
                charLayer.style.zIndex = "50";
                if (window.nextLevelAction) {
                  const callback = window.nextLevelAction;
                  window.nextLevelAction = null;
                  LETTER_OPEN = false; // üîß ADD THIS: Reset flag before next level
                  callback();
                }
              }, 500);
            };
          }
        }, 500);
      };

      // LEVEL 1
      function startLevel1() {
        if (GAME_COMPLETED || GAME_IN_PROGRESS) return;
        GAME_IN_PROGRESS = true; // üîß Lock the game
        CURRENT_LEVEL = 1;

        // üîß ADD THIS: Hide character layer during gameplay
        charLayer.classList.add("opacity-0");
        setTimeout(() => charLayer.classList.add("hidden"), 1000);

        stage.innerHTML = `
            <div class="glass-panel w-full max-w-md h-[480px] rounded-xl overflow-hidden fade-in flex flex-col">
            <div class="p-4 text-center border-b border-yellow-500/30">
                <h3 class="cinzel text-xl text-yellow-500">Level I: Memory Lane</h3>
                <p class="text-xs text-gray-400 mt-1">Match the memories before time runs out</p>
                <p id="timer" class="mt-2 text-sm text-yellow-300">‚è≥ 60s</p>
            </div>

            <div id="memory-grid" class="grid grid-cols-4 gap-3 p-4 flex-1"></div>
            </div>
        `;

        initMemoryGame();
      }

      function resetLevel1() {
        if (CURRENT_LEVEL !== 1 || GAME_COMPLETED) return;
        GAME_IN_PROGRESS = false; // üîß Unlock before reset
        if (window.currentMemoryTimer) {
          clearInterval(window.currentMemoryTimer);
          window.currentMemoryTimer = null;
        }
        startLevel1();
      }

      function initMemoryGame() {
        const icons = [
          "üçï",
          "üçï",
          "üíç",
          "üíç",
          "‚ù§Ô∏è",
          "‚ù§Ô∏è",
          "üéÆ",
          "üéÆ",
          "‚úàÔ∏è",
          "‚úàÔ∏è",
          "üì∏",
          "üì∏",
        ];
        const grid = document.getElementById("memory-grid");
        const timerEl = document.getElementById("timer");

        let shuffled = icons.sort(() => Math.random() - 0.5);
        let flipped = [];
        let matched = 0;
        let timeLeft = 60;
        let timer = null;

        // Clear any existing timer before starting new one
        if (window.currentMemoryTimer) {
          clearInterval(window.currentMemoryTimer);
        }

        // ‚è≥ TIMER - UPDATE THIS PART
        window.currentMemoryTimer = setInterval(() => {
          timeLeft--;
          timerEl.textContent = `‚è≥ ${timeLeft}s`;
          if (timeLeft <= 0) {
            clearInterval(window.currentMemoryTimer);
            window.currentMemoryTimer = null; // Clean reference
            resetLevel1();
          }
        }, 1000);

        shuffled.forEach((icon) => {
          const card = document.createElement("div");
          card.className =
            "bg-[#1e1e2f] border border-[var(--gold)] rounded-lg flex items-center justify-center text-3xl cursor-pointer select-none transition-all duration-300";
          card.dataset.icon = icon;
          card.dataset.flipped = "false";
          card.textContent = "‚ùì";

          card.onclick = () => {
            if (card.dataset.flipped === "true" || flipped.length === 2) return;

            card.textContent = icon;
            card.dataset.flipped = "true";
            card.classList.add("bg-black");
            flipped.push(card);

            if (flipped.length === 2) {
              setTimeout(() => {
                const [a, b] = flipped;
                if (a.dataset.icon === b.dataset.icon) {
                  matched += 2;
                  a.classList.add("ring-2", "ring-yellow-400");
                  b.classList.add("ring-2", "ring-yellow-400");
                  if (navigator.vibrate) navigator.vibrate(50);
                } else {
                  a.textContent = "‚ùì";
                  b.textContent = "‚ùì";
                  a.dataset.flipped = "false";
                  b.dataset.flipped = "false";
                }
                flipped = [];

                // üéâ WIN CONDITION
                if (matched === icons.length) {
                  clearInterval(window.currentMemoryTimer);
                  window.currentMemoryTimer = null;
                  GAME_IN_PROGRESS = false; // üîß Unlock before transition
                  setTimeout(() => {
                    startDialogue(SCRIPT.level1Done, () => {
                      showIntermediateLetter(LOVE_NOTES.afterLevel1, () => {
                        startDialogue(SCRIPT.level2Intro, startLevel2);
                      });
                    });
                  }, 500);
                }
              }, 600);
            }
          };

          grid.appendChild(card);
        });
      }

      // LEVEL 2
      function startLevel2() {
        if (GAME_COMPLETED) return;
        CURRENT_LEVEL = 2;
        stage.innerHTML = `
                <div class="glass-panel w-full max-w-md h-[450px] relative rounded-xl overflow-hidden fade-in flex flex-col">
                    <div class="p-4 text-center border-b border-yellow-500/30">
                        <h3 class="cinzel text-xl text-yellow-500">Level II: Seeker's Challenge</h3>
                        <p class="text-xs text-gray-400 mt-1">Catch the Snitch 5 times!</p>
                    </div>
                    <div class="flex-1 relative">
                        <canvas id="gameCanvas" class="absolute inset-0 w-full h-full touch-none"></canvas>
                    </div>
                    <div class="p-3 flex items-center justify-center gap-2">
                        ${[...Array(5)]
                          .map(
                            () =>
                              '<div class="snitch-hp w-8 h-8 rounded-full border-2 border-red-500 bg-red-900/50"></div>'
                          )
                          .join("")}
                    </div>
                </div>
            `;
        setTimeout(initSnitchGame, 100);
      }

      function initSnitchGame() {
        if (window.currentSnitchLoop) {
          cancelAnimationFrame(window.currentSnitchLoop);
        }

        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;
        const hpIndicators = document.querySelectorAll(".snitch-hp");

        let snitch = {
          x: canvas.width / 2,
          y: canvas.height / 2,
          vx: 2,
          vy: 2,
          hp: 5,
          angle: 0,
        };
        let loopId;

        function update() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          snitch.x += snitch.vx;
          snitch.y += snitch.vy;
          snitch.angle += 0.1;
          if (snitch.x < 20 || snitch.x > canvas.width - 20) snitch.vx *= -1;
          if (snitch.y < 20 || snitch.y > canvas.height - 20) snitch.vy *= -1;

          ctx.beginPath();
          ctx.arc(snitch.x, snitch.y, 15, 0, Math.PI * 2);
          ctx.fillStyle = "gold";
          ctx.fill();
          ctx.fillStyle = "white";
          ctx.save();
          ctx.translate(snitch.x, snitch.y);
          ctx.rotate(Math.sin(snitch.angle) * 0.5);
          ctx.fillRect(-25, -5, 50, 10);
          ctx.restore();

          window.currentSnitchLoop = requestAnimationFrame(update);
          loopId = window.currentSnitchLoop;
        }

        const tap = (e) => {
          e.preventDefault();
          const r = canvas.getBoundingClientRect();
          const cx = e.touches ? e.touches[0].clientX : e.clientX;
          const cy = e.touches ? e.touches[0].clientY : e.clientY;
          if (
            Math.hypot(snitch.x - (cx - r.left), snitch.y - (cy - r.top)) < 40
          ) {
            snitch.hp--;
            if (navigator.vibrate) navigator.vibrate(50);
            hpIndicators[snitch.hp].style.background = "transparent";
            snitch.vx *= 1.2;
            snitch.vy *= 1.2;

            if (snitch.hp <= 0) {
              // --- STOP LAG: Stop animation loop ---
              cancelAnimationFrame(loopId);

              setTimeout(() => {
                startDialogue(SCRIPT.level2Done, () => {
                  showIntermediateLetter(LOVE_NOTES.afterLevel2, () => {
                    startDialogue(SCRIPT.level3Intro, startLevel3);
                  });
                });
              }, 500);
            }
          }
        };

        canvas.addEventListener("mousedown", tap);
        canvas.addEventListener("touchstart", tap, { passive: false });
        update();
      }

      // LEVEL 3
      function startLevel3() {
        if (GAME_COMPLETED) return;
        CURRENT_LEVEL = 3;
        stage.innerHTML = `
                <div class="glass-panel w-full max-w-md h-[450px] relative rounded-xl overflow-hidden fade-in flex flex-col">
                    <div class="p-4 text-center border-b border-yellow-500/30">
                        <h3 class="cinzel text-xl text-yellow-500">Level III: Constellation of the Heart</h3>
                        <p class="text-xs text-gray-400 mt-1">Connect the stars in order: 1 ‚Üí 6 ‚Üí 1</p>
                    </div>
                    <div id="star-container" class="relative flex-1"></div>
                </div>
            `;
        initConstellation();
      }

      function initConstellation() {
        const container = document.getElementById("star-container");
        const stars = [
          { x: 50, y: 82 },
          { x: 22, y: 52 },
          { x: 30, y: 28 },
          { x: 50, y: 42 },
          { x: 70, y: 28 },
          { x: 78, y: 52 },
        ];

        const sequence = [0, 1, 2, 3, 4, 5, 0];
        let step = 0;
        const svg = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "svg"
        );
        svg.setAttribute(
          "class",
          "absolute inset-0 w-full h-full pointer-events-none z-10"
        );
        container.appendChild(svg);

        stars.forEach((s, i) => {
          const el = document.createElement("div");
          el.className =
            "absolute w-10 h-10 rounded-full cursor-pointer z-20 transition-all duration-300 bg-white shadow-[0_0_15px_white]";
          el.style.left = `calc(${s.x}% - 20px)`;
          el.style.top = `calc(${s.y}% - 20px)`;
          el.innerHTML = `<div class="absolute inset-0 flex items-center justify-center text-xs font-bold text-gray-800">${
            i + 1
          }</div>`;

          const handleInteract = (e) => {
            e.preventDefault();
            if (i === sequence[step]) {
              el.style.background = "gold";
              el.classList.add("star-glow");
              el.classList.remove("star-guide");
              if (navigator.vibrate) navigator.vibrate(50);

              if (step < sequence.length - 1) {
                const nextIndex = sequence[step + 1];
                const allStars = container.querySelectorAll("div.absolute");
                if (allStars[nextIndex])
                  allStars[nextIndex].classList.add("star-guide");
              }

              if (step > 0) {
                const prev = stars[sequence[step - 1]];
                const line = document.createElementNS(
                  "http://www.w3.org/2000/svg",
                  "line"
                );
                line.setAttribute("x1", prev.x + "%");
                line.setAttribute("y1", prev.y + "%");
                line.setAttribute("x2", s.x + "%");
                line.setAttribute("y2", s.y + "%");
                line.setAttribute("stroke", "gold");
                line.setAttribute("stroke-width", "3");
                svg.appendChild(line);
              }

              step++;
              if (step >= sequence.length) {
                setTimeout(() => {
                  startDialogue(SCRIPT.finale, triggerGrandFinale);
                }, 500);
              }
            }
          };
          if ("ontouchstart" in window) {
            el.ontouchstart = handleInteract;
          } else {
            el.onclick = handleInteract;
          }

          container.appendChild(el);
        });
        const firstStar = container.querySelectorAll("div.absolute")[0];
        if (firstStar) firstStar.classList.add("star-guide");
      }

      // --- GRAND FINALE (VIDEO) ---
      function triggerGrandFinale() {
        GAME_COMPLETED = true;
        // 1. Hide Owl and Dialogue
        charLayer.classList.add("opacity-0");
        bubbleLayer.classList.add("opacity-0");

        // 2. Trigger Lumos Transition
        const overlay = document.getElementById("lumos-overlay");
        overlay.classList.add("lumos-active");

        // 3. Prepare Video Stage (Behind the flash)
        setTimeout(() => {
          stage.innerHTML = `
                    <div class="fade-in w-full h-full flex flex-col items-center justify-center relative">
                        <div class="relative w-full aspect-[9/16] max-h-[70vh] border-4 border-[var(--gold)] rounded-lg shadow-[0_0_50px_rgba(212,175,55,0.5)] bg-black overflow-hidden">
                            <video id="birthdayVideo" class="w-full h-full object-cover" controls playsinline>
                                <source src="video.mp4" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                        <h1 class="cinzel text-3xl mt-8 text-gold text-center animate-pulse">Happy 24th Birthday Love</h1>
                    </div>
                `;
        }, 2000); // Wait for screen to go black before swapping HTML

        // 4. Play Video after flash clears
        setTimeout(() => {
          const vid = document.getElementById("birthdayVideo");
          if (vid)
            vid
              .play()
              .catch((e) => console.log("Auto-play blocked, user must tap"));
        }, 4000);
      }

      function initParticles() {
        const c = document.getElementById("particles");
        for (let i = 0; i < 30; i++) {
          const d = document.createElement("div");
          d.style.cssText = `position: absolute; width: ${
            Math.random() * 3
          }px; height: ${Math.random() * 3}px; background: white; top: ${
            Math.random() * 100
          }%; left: ${
            Math.random() * 100
          }%; opacity: ${Math.random()}; animation: float ${
            5 + Math.random() * 5
          }s infinite; border-radius: 50%;`;
          c.appendChild(d);
        }
      }
    </script>
  </body>
</html>
